<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡ŒåŠ¨æ•°å€¼ç¼–è¾‘å™¨ | Era Path Actions Editor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .file-loader {
            text-align: center;
            padding: 40px;
            border: 2px dashed #4CAF50;
            border-radius: 10px;
            margin: 20px 0;
            background: #f8f8f8;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        select, input, button {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        button {
            background: #4CAF50;
            color: white;
            cursor: pointer;
            border: none;
            transition: background 0.3s;
        }
        
        button:hover { background: #45a049; }
        
        .save-btn { background: #ff9800; }
        .save-btn:hover { background: #f57c00; }
        
        .reset-btn { background: #f44336; }
        .reset-btn:hover { background: #da190b; }
        
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        
        .action-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            background: #fafafa;
        }
        
        .action-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ddd;
        }
        
        .action-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .action-desc {
            color: #666;
            font-size: 14px;
        }
        
        .action-type {
            display: inline-block;
            padding: 4px 8px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .values-section {
            margin: 15px 0;
        }
        
        .values-title {
            font-weight: 600;
            color: #555;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .value-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .value-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .value-input {
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
        }
        
        .costs .value-input {
            background: #ffebee;
            border-color: #e57373;
        }
        
        .effects .value-input {
            background: #e8f5e8;
            border-color: #81c784;
        }
        
        .investment .value-input {
            background: #fff3e0;
            border-color: #ffb74d;
        }
        
        .stage-section {
            margin-bottom: 40px;
        }
        
        .stage-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stage-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .status-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        
        .status-bar.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .hidden { display: none; }
        .editor-content { display: none; }
        .editor-content.show { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ—¶ä»£ä¹‹è·¯ - è¡ŒåŠ¨æ•°å€¼ç¼–è¾‘å™¨</h1>
            <div style="color: #666; margin-top: 10px;">
                ç›´æ¥è¯»å–å’Œä¿®æ”¹ actions.js æ–‡ä»¶ï¼Œåªä¿®æ”¹æ•°å€¼ï¼Œä¿æŒä»£ç ç»“æ„ä¸å˜
            </div>
        </div>
        
        <!-- æ–‡ä»¶åŠ è½½åŒºåŸŸ -->
        <div id="file-loader" class="file-loader">
            <h3>ğŸ“ åŠ è½½ actions.js æ–‡ä»¶</h3>
            <p>è¯·é€‰æ‹©ä½ çš„ actions.js æ–‡ä»¶æ¥å¼€å§‹ç¼–è¾‘</p>
            <input type="file" id="file-input" accept=".js" style="display: none;">
            <button onclick="document.getElementById('file-input').click()">é€‰æ‹© actions.js æ–‡ä»¶</button>
        </div>
        
        <!-- ç¼–è¾‘å™¨å†…å®¹ -->
        <div id="editor-content" class="editor-content">
            <div class="controls">
                <div class="control-group">
                    <label>æ–‡æ˜é˜¶æ®µ:</label>
                    <select id="stage-filter">
                        <option value="all">å…¨éƒ¨é˜¶æ®µ</option>
                        <option value="0">éƒ¨è½æ–‡æ˜</option>
                        <option value="1">å†œä¸šæ–‡æ˜</option>
                        <option value="2">åŸé‚¦æ–‡æ˜</option>
                        <option value="3">å¸å›½æ—¶ä»£</option>
                        <option value="4">å·¥ä¸šæ–‡æ˜</option>
                        <option value="5">ä¿¡æ¯æ–‡æ˜</option>
                        <option value="6">æ˜Ÿé™…æ–‡æ˜</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>è¡ŒåŠ¨ç±»å‹:</label>
                    <select id="type-filter">
                        <option value="all">å…¨éƒ¨ç±»å‹</option>
                        <option value="amplify">å¼ºåŒ–</option>
                        <option value="counter">æŠµæ¶ˆ</option>
                        <option value="convert">è½¬åŒ–</option>
                        <option value="invest">æŠ•èµ„</option>
                        <option value="emergency">åº”æ€¥</option>
                        <option value="synergy">ååŒ</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>æœç´¢:</label>
                    <input type="text" id="search-box" placeholder="è¾“å…¥è¡ŒåŠ¨åç§°æˆ–æè¿°...">
                </div>
                
                <button id="save-btn" class="save-btn">ğŸ’¾ ä¸‹è½½ä¿®æ”¹åçš„æ–‡ä»¶</button>
                <button id="reset-btn" class="reset-btn">ğŸ”„ é‡ç½®æ‰€æœ‰ä¿®æ”¹</button>
            </div>
            
            <div id="actions-container"></div>
        </div>
    </div>
    
    <div id="status-bar" class="status-bar"></div>
    
    <script>
        // å…¨å±€çŠ¶æ€
        let originalFileContent = '';
        let editorActionPool = null;  // æ”¹åé¿å…å†²çª
        let originalActionPool = null;
        
        // èµ„æºç±»å‹æ˜ å°„
        const resourceNames = {
            population: 'äººå£',
            food: 'é£Ÿç‰©',
            tech: 'ç§‘æŠ€',
            environment: 'ç¯å¢ƒ',
            order: 'ç§©åº',
            military: 'å†›äº‹',
            culture: 'æ–‡åŒ–'
        };
        
        // è¡ŒåŠ¨ç±»å‹æ˜ å°„
        const actionTypeNames = {
            amplify: 'å¼ºåŒ–',
            counter: 'æŠµæ¶ˆ',
            convert: 'è½¬åŒ–',
            invest: 'æŠ•èµ„',
            emergency: 'åº”æ€¥',
            synergy: 'ååŒ'
        };
        
        // æ–‡æ˜é˜¶æ®µåç§°
        const stageNames = {
            0: 'éƒ¨è½æ–‡æ˜',
            1: 'å†œä¸šæ–‡æ˜',
            2: 'åŸé‚¦æ–‡æ˜',
            3: 'å¸å›½æ—¶ä»£',
            4: 'å·¥ä¸šæ–‡æ˜',
            5: 'ä¿¡æ¯æ–‡æ˜',
            6: 'æ˜Ÿé™…æ–‡æ˜'
        };
        
        // åˆå§‹åŒ–
        function init() {
            document.getElementById('file-input').addEventListener('change', handleFileLoad);
            document.getElementById('stage-filter').addEventListener('change', renderActions);
            document.getElementById('type-filter').addEventListener('change', renderActions);
            document.getElementById('search-box').addEventListener('input', renderActions);
            document.getElementById('save-btn').addEventListener('click', saveFile);
            document.getElementById('reset-btn').addEventListener('click', resetChanges);
        }
        
        // å¤„ç†æ–‡ä»¶åŠ è½½
        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                originalFileContent = e.target.result;
                
                if (parseActionsFile()) {
                    document.getElementById('file-loader').style.display = 'none';
                    document.getElementById('editor-content').classList.add('show');
                    renderActions();
                    showStatus('âœ… æ–‡ä»¶åŠ è½½æˆåŠŸï¼');
                } else {
                    showStatus('âŒ æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿è¿™æ˜¯æœ‰æ•ˆçš„ actions.js æ–‡ä»¶');
                }
            };
            reader.readAsText(file);
        }
        
        // è§£æ actions.js æ–‡ä»¶
        function parseActionsFile() {
            try {
                // æ¸…ç†ä¹‹å‰å¯èƒ½å­˜åœ¨çš„ actionPool
                if (typeof window.actionPool !== 'undefined') {
                    delete window.actionPool;
                }
                
                // åˆ›å»ºä¸€ä¸ªéš”ç¦»çš„æ‰§è¡Œç¯å¢ƒ
                const tempScript = document.createElement('script');
                
                // ä¿®æ”¹æ–‡ä»¶å†…å®¹ï¼Œé¿å…å˜é‡é‡å¤å£°æ˜
                let modifiedContent = originalFileContent;
                
                // å°† const actionPool æ”¹ä¸º window.actionPoolï¼Œé¿å…é‡å¤å£°æ˜
                modifiedContent = modifiedContent.replace(/const actionPool\s*=/, 'window.actionPool =');
                modifiedContent = modifiedContent.replace(/let actionPool\s*=/, 'window.actionPool =');
                modifiedContent = modifiedContent.replace(/var actionPool\s*=/, 'window.actionPool =');
                
                tempScript.textContent = modifiedContent;
                document.head.appendChild(tempScript);
                
                // æ£€æŸ¥æ˜¯å¦æˆåŠŸè§£æ
                if (typeof window.actionPool !== 'undefined') {
                    // å¤åˆ¶åˆ°æœ¬åœ°å˜é‡
                    editorActionPool = JSON.parse(JSON.stringify(window.actionPool));
                    originalActionPool = JSON.parse(JSON.stringify(window.actionPool));
                    
                    // æ¸…ç†
                    document.head.removeChild(tempScript);
                    delete window.actionPool;
                    
                    return true;
                }
                
                document.head.removeChild(tempScript);
                throw new Error('æœªæ‰¾åˆ° actionPool å®šä¹‰');
            } catch (error) {
                console.error('è§£ææ–‡ä»¶å¤±è´¥:', error);
                showStatus('âŒ è§£æå¤±è´¥: ' + error.message);
                return false;
            }
        }
        
        // æ¸²æŸ“è¡ŒåŠ¨åˆ—è¡¨
        function renderActions() {
            if (!editorActionPool) return;
            
            const container = document.getElementById('actions-container');
            const stageFilter = document.getElementById('stage-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            const searchText = document.getElementById('search-box').value.toLowerCase();
            
            container.innerHTML = '';
            
            const stageKeys = stageFilter === 'all' ? Object.keys(editorActionPool) : [stageFilter];
            
            stageKeys.forEach(stageKey => {
                const stage = editorActionPool[stageKey];
                if (!stage) return;
                
                let stageActions = [];
                
                Object.keys(stage).forEach(actionType => {
                    if (typeFilter !== 'all' && actionType !== typeFilter) return;
                    
                    stage[actionType].forEach((action, index) => {
                        if (searchText && !action.name.toLowerCase().includes(searchText) && 
                            !action.desc.toLowerCase().includes(searchText)) return;
                        
                        stageActions.push({
                            ...action,
                            stageKey,
                            actionType,
                            actionIndex: index
                        });
                    });
                });
                
                if (stageActions.length === 0) return;
                
                const stageSection = document.createElement('div');
                stageSection.className = 'stage-section';
                
                const stageHeader = document.createElement('div');
                stageHeader.className = 'stage-header';
                stageHeader.innerHTML = `
                    <div class="stage-title">${stageNames[stageKey]} (${stageActions.length}ä¸ªè¡ŒåŠ¨)</div>
                `;
                stageSection.appendChild(stageHeader);
                
                const actionsGrid = document.createElement('div');
                actionsGrid.className = 'actions-grid';
                
                stageActions.forEach(action => {
                    const actionCard = createActionCard(action);
                    actionsGrid.appendChild(actionCard);
                });
                
                stageSection.appendChild(actionsGrid);
                container.appendChild(stageSection);
            });
        }
        
        // åˆ›å»ºè¡ŒåŠ¨å¡ç‰‡
        function createActionCard(action) {
            const card = document.createElement('div');
            card.className = 'action-card';
            
            let investmentSection = '';
            if (action.investment) {
                investmentSection = `
                    <div class="values-section investment">
                        <div class="values-title">æŠ•èµ„å›æŠ¥ (Investment Returns)</div>
                        <div style="margin-bottom: 10px;">
                            <label class="value-label">æŠ•èµ„å‘¨æœŸ (turns):</label>
                            <input type="number" 
                                   class="value-input" 
                                   value="${action.investment.turns || 0}"
                                   data-action-key="${action.key}"
                                   data-stage="${action.stageKey}"
                                   data-type="${action.actionType}"
                                   data-index="${action.actionIndex}"
                                   data-resource="turns"
                                   data-section="investment"
                                   onchange="updateValue(this)"
                                   style="width: 80px;">
                        </div>
                        <div class="values-grid">
                            ${renderResourceInputs(action.investment.returns || {}, 'investment-returns', action)}
                        </div>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="action-header">
                    <div class="action-name">${action.name}</div>
                    <div class="action-desc">${action.desc}</div>
                    <div class="action-type">${actionTypeNames[action.actionType]}</div>
                </div>
                
                <div class="values-section costs">
                    <div class="values-title">æ¶ˆè€— (Costs)</div>
                    <div class="values-grid">
                        ${renderResourceInputs(action.costs || {}, 'costs', action)}
                    </div>
                </div>
                
                <div class="values-section effects">
                    <div class="values-title">æ•ˆæœ (Effects)</div>
                    <div class="values-grid">
                        ${renderResourceInputs(action.effects || {}, 'effects', action)}
                    </div>
                </div>
                
                ${investmentSection}
            `;
            
            return card;
        }
        
        // æ¸²æŸ“èµ„æºè¾“å…¥æ¡†
        function renderResourceInputs(resources, type, action) {
            const allResources = ['population', 'food', 'tech', 'environment', 'order', 'military', 'culture'];
            
            return allResources.map(resource => {
                const value = resources[resource] || 0;
                return `
                    <div class="value-item">
                        <label class="value-label">${resourceNames[resource]}</label>
                        <input type="number" 
                               class="value-input" 
                               value="${value}"
                               data-action-key="${action.key}"
                               data-stage="${action.stageKey}"
                               data-type="${action.actionType}"
                               data-index="${action.actionIndex}"
                               data-resource="${resource}"
                               data-section="${type}"
                               onchange="updateValue(this)">
                    </div>
                `;
            }).join('');
        }
        
        // æ›´æ–°æ•°å€¼
        function updateValue(input) {
            const stage = input.dataset.stage;
            const type = input.dataset.type;
            const index = parseInt(input.dataset.index);
            const resource = input.dataset.resource;
            const section = input.dataset.section;
            const newValue = parseInt(input.value) || 0;
            
            // å¤„ç†æŠ•èµ„ç›¸å…³çš„æ›´æ–°
            if (section === 'investment') {
                if (!editorActionPool[stage][type][index].investment) {
                    editorActionPool[stage][type][index].investment = { turns: 0, returns: {} };
                }
                editorActionPool[stage][type][index].investment.turns = newValue;
            } else if (section === 'investment-returns') {
                if (!editorActionPool[stage][type][index].investment) {
                    editorActionPool[stage][type][index].investment = { turns: 0, returns: {} };
                }
                if (newValue === 0) {
                    delete editorActionPool[stage][type][index].investment.returns[resource];
                } else {
                    editorActionPool[stage][type][index].investment.returns[resource] = newValue;
                }
            } else {
                // å¤„ç†å¸¸è§„çš„ costs å’Œ effects
                if (!editorActionPool[stage][type][index][section]) {
                    editorActionPool[stage][type][index][section] = {};
                }
                
                if (newValue === 0) {
                    delete editorActionPool[stage][type][index][section][resource];
                } else {
                    editorActionPool[stage][type][index][section][resource] = newValue;
                }
            }
            
            // è§†è§‰åé¦ˆ
            input.style.background = '#ffeb3b';
            setTimeout(() => {
                input.style.background = '';
            }, 1000);
        }
        
        // ä¿å­˜æ–‡ä»¶
        function saveFile() {
            try {
                // æ›¿æ¢æ–‡ä»¶ä¸­çš„æ•°å€¼
                let newContent = originalFileContent;
                
                // éå†æ‰€æœ‰ä¿®æ”¹ï¼Œæ›¿æ¢å¯¹åº”çš„æ•°å€¼
                Object.keys(editorActionPool).forEach(stageKey => {
                    Object.keys(editorActionPool[stageKey]).forEach(actionType => {
                        editorActionPool[stageKey][actionType].forEach((action, index) => {
                            const originalAction = originalActionPool[stageKey][actionType][index];
                            
                            // æ¯”è¾ƒå¹¶æ›¿æ¢ costs
                            if (action.costs && originalAction.costs) {
                                Object.keys(originalAction.costs).forEach(resource => {
                                    const oldValue = originalAction.costs[resource];
                                    const newValue = action.costs[resource] || 0;
                                    if (oldValue !== newValue) {
                                        newContent = replaceValueInFile(newContent, action.key, 'costs', resource, oldValue, newValue);
                                    }
                                });
                            }
                            
                            // æ¯”è¾ƒå¹¶æ›¿æ¢ effects
                            if (action.effects && originalAction.effects) {
                                Object.keys(originalAction.effects).forEach(resource => {
                                    const oldValue = originalAction.effects[resource];
                                    const newValue = action.effects[resource] || 0;
                                    if (oldValue !== newValue) {
                                        newContent = replaceValueInFile(newContent, action.key, 'effects', resource, oldValue, newValue);
                                    }
                                });
                            }
                            
                            // æ¯”è¾ƒå¹¶æ›¿æ¢æŠ•èµ„æ•°æ®
                            if (action.investment && originalAction.investment) {
                                // æ›¿æ¢æŠ•èµ„å‘¨æœŸ
                                if (action.investment.turns !== originalAction.investment.turns) {
                                    newContent = replaceInvestmentValue(newContent, action.key, 'turns', originalAction.investment.turns, action.investment.turns);
                                }
                                
                                // æ›¿æ¢æŠ•èµ„å›æŠ¥
                                if (action.investment.returns && originalAction.investment.returns) {
                                    Object.keys(originalAction.investment.returns).forEach(resource => {
                                        const oldValue = originalAction.investment.returns[resource];
                                        const newValue = action.investment.returns[resource] || 0;
                                        if (oldValue !== newValue) {
                                            newContent = replaceInvestmentReturnValue(newContent, action.key, resource, oldValue, newValue);
                                        }
                                    });
                                }
                            }
                        });
                    });
                });
                
                // ä¸‹è½½æ–‡ä»¶
                const blob = new Blob([newContent], { type: 'text/javascript' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'actions.js';
                link.click();
                URL.revokeObjectURL(url);
                
                showStatus('âœ… ä¿®æ”¹åçš„æ–‡ä»¶å·²ä¸‹è½½ï¼');
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                showStatus('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // åœ¨æ–‡ä»¶ä¸­æ›¿æ¢ç‰¹å®šæ•°å€¼
        function replaceValueInFile(content, actionKey, section, resource, oldValue, newValue) {
            // æ„å»ºç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼æ¥åŒ¹é…ç‰¹å®šè¡ŒåŠ¨çš„ç‰¹å®šèµ„æº
            const pattern = new RegExp(
                `(key:\\s*['"]${actionKey}['"][\\s\\S]*?${section}:\\s*{[^}]*?${resource}:\\s*)${oldValue}(\\s*[,}])`,
                'g'
            );
            
            return content.replace(pattern, `$1${newValue}$2`);
        }
        
        // æ›¿æ¢æŠ•èµ„å‘¨æœŸ
        function replaceInvestmentValue(content, actionKey, property, oldValue, newValue) {
            const pattern = new RegExp(
                `(key:\\s*['"]${actionKey}['"][\\s\\S]*?investment:\\s*{[^}]*?${property}:\\s*)${oldValue}(\\s*[,}])`,
                'g'
            );
            
            return content.replace(pattern, `$1${newValue}$2`);
        }
        
        // æ›¿æ¢æŠ•èµ„å›æŠ¥æ•°å€¼
        function replaceInvestmentReturnValue(content, actionKey, resource, oldValue, newValue) {
            const pattern = new RegExp(
                `(key:\\s*['"]${actionKey}['"][\\s\\S]*?investment:\\s*{[\\s\\S]*?returns:\\s*{[^}]*?${resource}:\\s*)${oldValue}(\\s*[,}])`,
                'g'
            );
            
            return content.replace(pattern, `$1${newValue}$2`);
        }
        
        // é‡ç½®æ‰€æœ‰ä¿®æ”¹
        function resetChanges() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ä¿®æ”¹å—ï¼Ÿè¿™å°†æ¢å¤åˆ°æ–‡ä»¶çš„åŸå§‹çŠ¶æ€ã€‚')) {
                if (originalActionPool) {
                    editorActionPool = JSON.parse(JSON.stringify(originalActionPool));
                    renderActions();
                    showStatus('âœ… å·²é‡ç½®æ‰€æœ‰ä¿®æ”¹');
                }
            }
        }
        
        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message) {
            const statusBar = document.getElementById('status-bar');
            statusBar.textContent = message;
            statusBar.classList.add('show');
            
            setTimeout(() => {
                statusBar.classList.remove('show');
            }, 3000);
        }
        
        // å…¨å±€å‡½æ•°
        window.updateValue = updateValue;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
